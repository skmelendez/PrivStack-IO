<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:tray="using:PrivStack.Desktop.ViewModels.AiTray"
             xmlns:sdk="using:PrivStack.Sdk.Capabilities"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="500"
             x:Class="PrivStack.Desktop.Views.AiSuggestionTray"
             x:DataType="tray:AiSuggestionTrayViewModel">

    <Grid RowDefinitions="*,Auto">

        <!-- ═══ Message List ═══ -->
        <ScrollViewer Grid.Row="0" Name="MessageScrollViewer"
                      VerticalScrollBarVisibility="Auto">
            <ItemsControl ItemsSource="{Binding Messages}" Margin="8">
                <ItemsControl.ItemTemplate>
                    <DataTemplate x:DataType="tray:AiChatMessageViewModel">
                        <Panel Margin="0,0,0,8">

                            <!-- ═══ User Bubble (right-aligned) ═══ -->
                            <Border IsVisible="{Binding IsUser}"
                                    HorizontalAlignment="Right"
                                    MaxWidth="320"
                                    Background="{DynamicResource ThemePrimaryBrush}"
                                    CornerRadius="12,12,4,12"
                                    Padding="12,8">
                                <StackPanel Spacing="4">
                                    <TextBlock Text="{Binding UserLabel}"
                                               TextWrapping="Wrap"
                                               Foreground="{DynamicResource ThemeTextOnAccentBrush}"
                                               FontSize="{DynamicResource ThemeFontSizeSm}"/>
                                    <!-- Source link -->
                                    <Button IsVisible="{Binding HasSourceLink}"
                                            Command="{Binding NavigateToSourceCommand}"
                                            Background="Transparent" BorderThickness="0"
                                            Padding="0" Cursor="Hand"
                                            HorizontalAlignment="Left">
                                        <TextBlock FontSize="{DynamicResource ThemeFontSizeXs}"
                                                   Foreground="{DynamicResource ThemeTextOnAccentBrush}"
                                                   Opacity="0.8"
                                                   TextDecorations="Underline">
                                            <Run Text="{Binding SourceEntityTitle, FallbackValue='this item'}"/>
                                        </TextBlock>
                                    </Button>
                                </StackPanel>
                            </Border>

                            <!-- ═══ Assistant Bubble (left-aligned) ═══ -->
                            <Border IsVisible="{Binding IsAssistant}"
                                    HorizontalAlignment="Left"
                                    MaxWidth="340"
                                    Background="{DynamicResource ThemeSurfaceElevatedBrush}"
                                    CornerRadius="12,12,12,4"
                                    Padding="12,8"
                                    BorderBrush="{DynamicResource ThemeBorderSubtleBrush}"
                                    BorderThickness="1">
                                <StackPanel Spacing="6">
                                    <!-- Loading state -->
                                    <StackPanel Orientation="Horizontal" Spacing="8"
                                                IsVisible="{Binding IsLoading}">
                                        <ProgressBar IsIndeterminate="True" Width="60" Height="3"/>
                                        <TextBlock Text="Thinking..."
                                                   FontSize="{DynamicResource ThemeFontSizeXs}"
                                                   Foreground="{DynamicResource ThemeTextMutedBrush}"/>
                                    </StackPanel>

                                    <!-- Error state -->
                                    <Border IsVisible="{Binding IsError}"
                                            Background="{DynamicResource ThemeDangerMutedBrush}"
                                            CornerRadius="{DynamicResource ThemeRadiusSm}"
                                            Padding="8,4">
                                        <TextBlock Text="{Binding ErrorMessage}"
                                                   FontSize="{DynamicResource ThemeFontSizeXs}"
                                                   Foreground="{DynamicResource ThemeDangerBrush}"
                                                   TextWrapping="Wrap"/>
                                    </Border>

                                    <!-- Content text -->
                                    <TextBlock Text="{Binding Content}"
                                               IsVisible="{Binding Content, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                               TextWrapping="Wrap"
                                               FontSize="{DynamicResource ThemeFontSizeSm}"
                                               Foreground="{DynamicResource ThemeTextSecondaryBrush}"/>

                                    <!-- Action buttons (Ready state) -->
                                    <ItemsControl ItemsSource="{Binding Actions}"
                                                  IsVisible="{Binding IsReady}">
                                        <ItemsControl.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <StackPanel Orientation="Horizontal" Spacing="6"/>
                                            </ItemsPanelTemplate>
                                        </ItemsControl.ItemsPanel>
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate x:DataType="sdk:SuggestionAction">
                                                <Button Content="{Binding DisplayName}"
                                                        Command="{Binding $parent[Border].((tray:AiChatMessageViewModel)DataContext).ExecuteActionCommand}"
                                                        CommandParameter="{Binding}"
                                                        Padding="8,4"
                                                        FontSize="{DynamicResource ThemeFontSizeSm}"
                                                        CornerRadius="{DynamicResource ThemeRadiusSm}"
                                                        Cursor="Hand"/>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>

                                    <!-- Applied state -->
                                    <StackPanel Orientation="Horizontal" Spacing="6"
                                                IsVisible="{Binding IsApplied}">
                                        <TextBlock Text="Applied"
                                                   FontSize="{DynamicResource ThemeFontSizeXs}"
                                                   Foreground="{DynamicResource ThemeSuccessBrush}"
                                                   VerticalAlignment="Center"/>
                                        <ItemsControl ItemsSource="{Binding Actions}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <StackPanel Orientation="Horizontal" Spacing="6"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate x:DataType="sdk:SuggestionAction">
                                                    <Button Content="{Binding DisplayName}"
                                                            Command="{Binding $parent[Border].((tray:AiChatMessageViewModel)DataContext).ExecuteActionCommand}"
                                                            CommandParameter="{Binding}"
                                                            Padding="8,4"
                                                            FontSize="{DynamicResource ThemeFontSizeSm}"
                                                            CornerRadius="{DynamicResource ThemeRadiusSm}"
                                                            Cursor="Hand"/>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </StackPanel>

                                    <!-- Dismiss link for content cards -->
                                    <Button IsVisible="{Binding SuggestionId, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                            Command="{Binding DismissCommand}"
                                            Background="Transparent" BorderThickness="0"
                                            Padding="0" Cursor="Hand"
                                            HorizontalAlignment="Left">
                                        <TextBlock Text="Dismiss"
                                                   FontSize="{DynamicResource ThemeFontSizeXs}"
                                                   Foreground="{DynamicResource ThemeTextMutedBrush}"/>
                                    </Button>
                                </StackPanel>
                            </Border>

                        </Panel>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- ═══ Empty State ═══ -->
        <TextBlock Grid.Row="0"
                   Text="Start a conversation..."
                   IsVisible="{Binding !HasCards}"
                   HorizontalAlignment="Center"
                   VerticalAlignment="Center"
                   Margin="0,40"
                   FontSize="{DynamicResource ThemeFontSizeSm}"
                   Foreground="{DynamicResource ThemeTextMutedBrush}"/>

        <!-- ═══ Chat Input Bar ═══ -->
        <Border Grid.Row="1"
                Background="{DynamicResource ThemeSurfaceElevatedBrush}"
                BorderBrush="{DynamicResource ThemeBorderSubtleBrush}"
                BorderThickness="0,1,0,0"
                Padding="8">
            <Grid ColumnDefinitions="*,Auto">
                <TextBox Name="ChatInputBox"
                         Text="{Binding ChatInputText, Mode=TwoWay}"
                         Watermark="Ask Hugo..."
                         FontSize="{DynamicResource ThemeFontSizeSm}"
                         CornerRadius="{DynamicResource ThemeRadiusSm}"
                         Padding="8,6"
                         VerticalAlignment="Center"/>
                <Button Grid.Column="1"
                        Content="Send"
                        Command="{Binding SendChatMessageCommand}"
                        Background="{DynamicResource ThemePrimaryBrush}"
                        Foreground="{DynamicResource ThemeTextOnAccentBrush}"
                        Padding="12,6"
                        Margin="6,0,0,0"
                        FontSize="{DynamicResource ThemeFontSizeSm}"
                        CornerRadius="{DynamicResource ThemeRadiusSm}"
                        VerticalAlignment="Center"
                        Cursor="Hand"/>
            </Grid>
        </Border>
    </Grid>
</UserControl>
