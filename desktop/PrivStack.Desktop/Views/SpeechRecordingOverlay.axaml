<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:PrivStack.Desktop.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="400" d:DesignHeight="200"
             x:Class="PrivStack.Desktop.Views.SpeechRecordingOverlay"
             x:DataType="vm:SpeechRecordingViewModel"
             IsVisible="{Binding IsVisible}">

    <UserControl.Styles>
        <!-- Pulse animation for recording indicator -->
        <Style Selector="Ellipse.pulse">
            <Style.Animations>
                <Animation Duration="0:0:1.2" IterationCount="INFINITE">
                    <KeyFrame Cue="0%">
                        <Setter Property="Opacity" Value="0.7"/>
                    </KeyFrame>
                    <KeyFrame Cue="50%">
                        <Setter Property="Opacity" Value="0.2"/>
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="Opacity" Value="0.7"/>
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
        <Style Selector="Ellipse.pulse-delayed">
            <Style.Animations>
                <Animation Duration="0:0:1.2" IterationCount="INFINITE" Delay="0:0:0.3">
                    <KeyFrame Cue="0%">
                        <Setter Property="Opacity" Value="0.5"/>
                    </KeyFrame>
                    <KeyFrame Cue="50%">
                        <Setter Property="Opacity" Value="0.1"/>
                    </KeyFrame>
                    <KeyFrame Cue="100%">
                        <Setter Property="Opacity" Value="0.5"/>
                    </KeyFrame>
                </Animation>
            </Style.Animations>
        </Style>
    </UserControl.Styles>

    <!-- Floating Recording Indicator -->
    <Grid>
        <!-- Semi-transparent backdrop -->
        <Border Classes="modal-backdrop-light" PointerPressed="OnBackdropPressed"/>

        <!-- Main Panel -->
        <Border Background="{DynamicResource ThemeSurfaceElevatedBrush}"
                CornerRadius="{DynamicResource ThemeRadiusLg}"
                HorizontalAlignment="Center"
                VerticalAlignment="Center"
                Padding="24,20"
                MinWidth="320"
                Classes="modal">

            <!-- States container - only one visible at a time -->
            <Grid>
                <!-- Download Prompt State -->
                <StackPanel Spacing="16" IsVisible="{Binding IsPromptingDownload}">
                <!-- Download Icon -->
                <Border Width="56" Height="56"
                        Background="{DynamicResource ThemePrimaryMutedBrush}"
                        CornerRadius="28"
                        HorizontalAlignment="Center">
                    <Path Data="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"
                          Fill="{DynamicResource ThemePrimaryBrush}"
                          Width="24" Height="24"
                          Stretch="Uniform"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"/>
                </Border>

                <!-- Prompt Text -->
                <StackPanel Spacing="4" HorizontalAlignment="Center">
                    <TextBlock Text="Download Speech Model?"
                               FontSize="{DynamicResource ThemeFontSizeLg}"
                               FontWeight="SemiBold"
                               HorizontalAlignment="Center"/>
                    <TextBlock HorizontalAlignment="Center"
                               FontSize="{DynamicResource ThemeFontSizeSm}"
                               Foreground="{DynamicResource ThemeTextSecondaryBrush}">
                        <Run Text="Speech-to-text requires downloading the"/>
                    </TextBlock>
                    <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" Spacing="4">
                        <TextBlock Text="{Binding ModelDisplayName}"
                                   FontWeight="SemiBold"
                                   FontSize="{DynamicResource ThemeFontSizeSm}"/>
                        <TextBlock Text="model"
                                   FontSize="{DynamicResource ThemeFontSizeSm}"
                                   Foreground="{DynamicResource ThemeTextSecondaryBrush}"/>
                        <TextBlock Text="{Binding ModelSizeDisplay, StringFormat='({0})'}"
                                   FontSize="{DynamicResource ThemeFontSizeSm}"
                                   Foreground="{DynamicResource ThemeTextMutedBrush}"/>
                    </StackPanel>
                </StackPanel>

                <!-- Buttons -->
                <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Center">
                    <Button Content="Not Now"
                            Command="{Binding DeclineDownloadCommand}"
                            Padding="16,8"
                            Background="{DynamicResource ThemeHoverBrush}"
                            Foreground="{DynamicResource ThemeTextSecondaryBrush}"/>
                    <Button Content="Download"
                            Command="{Binding ConfirmDownloadCommand}"
                            Padding="16,8"
                            Background="{DynamicResource ThemePrimaryBrush}"
                            Foreground="{DynamicResource ThemeTextOnAccentBrush}"/>
                </StackPanel>
            </StackPanel>

            <!-- Downloading State -->
            <StackPanel Spacing="16" IsVisible="{Binding IsDownloading}">
                <!-- Download Icon with progress ring would go here -->
                <Border Width="56" Height="56"
                        Background="{DynamicResource ThemePrimaryMutedBrush}"
                        CornerRadius="28"
                        HorizontalAlignment="Center">
                    <Path Data="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"
                          Fill="{DynamicResource ThemePrimaryBrush}"
                          Width="24" Height="24"
                          Stretch="Uniform"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"/>
                </Border>

                <TextBlock Text="{Binding StatusText}"
                           FontSize="{DynamicResource ThemeFontSizeMd}"
                           FontWeight="Medium"
                           HorizontalAlignment="Center"/>

                <StackPanel Spacing="8" Width="250">
                    <ProgressBar Value="{Binding DownloadProgress}"
                                 Minimum="0" Maximum="100"
                                 Height="6"
                                 Foreground="{DynamicResource ThemePrimaryBrush}"
                                 Background="{DynamicResource ThemeBorderSubtleBrush}"/>
                    <TextBlock Text="{Binding DownloadProgress, StringFormat='{}{0:F0}%'}"
                               FontSize="{DynamicResource ThemeFontSizeSm}"
                               Foreground="{DynamicResource ThemeTextMutedBrush}"
                               HorizontalAlignment="Center"/>
                </StackPanel>

                <Button Content="Cancel"
                        Command="{Binding CancelDownloadCommand}"
                        HorizontalAlignment="Center"
                        Padding="16,8"
                        Background="{DynamicResource ThemeHoverBrush}"
                        Foreground="{DynamicResource ThemeTextSecondaryBrush}"/>
            </StackPanel>

            <!-- Recording State -->
            <StackPanel Spacing="16" IsVisible="{Binding IsRecording}">
                <!-- Microphone Icon with Pulse Animation -->
                <Grid HorizontalAlignment="Center">
                    <!-- Pulse ring - animated opacity for recording indicator -->
                    <Ellipse Width="72" Height="72"
                             Fill="{DynamicResource ThemeDangerMutedBrush}"
                             Classes="pulse"/>

                    <!-- Inner pulse ring -->
                    <Ellipse Width="64" Height="64"
                             Fill="{DynamicResource ThemeDangerMutedBrush}"
                             Opacity="0.5"
                             Classes="pulse-delayed"/>

                    <!-- Microphone circle background -->
                    <Ellipse Width="56" Height="56"
                             Fill="{DynamicResource ThemeDangerBrush}"/>

                    <!-- Microphone Icon -->
                    <Path Data="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"
                          Fill="{DynamicResource ThemeTextOnAccentBrush}"
                          Width="24" Height="24"
                          Stretch="Uniform"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"/>
                </Grid>

                <!-- Status Text -->
                <TextBlock Text="{Binding StatusText}"
                           FontSize="{DynamicResource ThemeFontSizeMd}"
                           Foreground="{DynamicResource ThemeTextPrimaryBrush}"
                           HorizontalAlignment="Center"
                           FontWeight="Medium"/>

                <!-- Duration -->
                <TextBlock HorizontalAlignment="Center"
                           FontSize="{DynamicResource ThemeFontSize2Xl}"
                           Foreground="{DynamicResource ThemeTextSecondaryBrush}"
                           FontFamily="{DynamicResource ThemeFontMono}">
                    <TextBlock.Text>
                        <MultiBinding StringFormat="{}{0:mm}:{0:ss}">
                            <Binding Path="Duration"/>
                        </MultiBinding>
                    </TextBlock.Text>
                </TextBlock>

                <!-- Cancel button -->
                <Button Content="Cancel (Esc)"
                        Command="{Binding CancelCommand}"
                        HorizontalAlignment="Center"
                        Padding="16,8"
                        FontSize="{DynamicResource ThemeFontSizeSm}"
                        Background="{DynamicResource ThemeHoverBrush}"
                        Foreground="{DynamicResource ThemeTextSecondaryBrush}"
                        CornerRadius="{DynamicResource ThemeRadiusSm}"/>
            </StackPanel>

            <!-- Transcribing State -->
            <StackPanel Spacing="16" IsVisible="{Binding IsTranscribing}">
                <!-- Processing Icon -->
                <Border Width="56" Height="56"
                        Background="{DynamicResource ThemePrimaryBrush}"
                        CornerRadius="28"
                        HorizontalAlignment="Center">
                    <Path Data="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm-1-9c0-.55.45-1 1-1s1 .45 1 1v6c0 .55-.45 1-1 1s-1-.45-1-1V5zm6 6c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"
                          Fill="{DynamicResource ThemeTextOnAccentBrush}"
                          Width="24" Height="24"
                          Stretch="Uniform"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"/>
                </Border>

                <TextBlock Text="{Binding StatusText}"
                           FontSize="{DynamicResource ThemeFontSizeMd}"
                           Foreground="{DynamicResource ThemeTextPrimaryBrush}"
                           HorizontalAlignment="Center"
                           FontWeight="Medium"/>

                <ProgressBar IsIndeterminate="True"
                             Height="4"
                             Width="200"
                             Foreground="{DynamicResource ThemePrimaryBrush}"
                             Background="{DynamicResource ThemeBorderSubtleBrush}"/>
            </StackPanel>

            <!-- Error State -->
            <StackPanel Spacing="12"
                        IsVisible="{Binding ErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}">
                <Border Background="{DynamicResource ThemeDangerMutedBrush}"
                        CornerRadius="{DynamicResource ThemeRadiusSm}"
                        Padding="12,8">
                    <TextBlock Text="{Binding ErrorMessage}"
                               FontSize="{DynamicResource ThemeFontSizeSm}"
                               Foreground="{DynamicResource ThemeDangerBrush}"
                               TextWrapping="Wrap"
                               MaxWidth="260"
                               HorizontalAlignment="Center"/>
                </Border>

                <Button Content="Close"
                        Command="{Binding CancelCommand}"
                        HorizontalAlignment="Center"
                        Padding="16,8"
                        Background="{DynamicResource ThemeHoverBrush}"
                        Foreground="{DynamicResource ThemeTextSecondaryBrush}"/>
            </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
