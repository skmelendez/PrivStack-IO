<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:PrivStack.Desktop.ViewModels"
             xmlns:plugin="using:PrivStack.Desktop.Services.Plugin"
             xmlns:sdk="using:PrivStack.Sdk"
             xmlns:cap="using:PrivStack.Sdk.Capabilities"
             xmlns:controls="using:PrivStack.Desktop.Controls"
             mc:Ignorable="d" d:DesignWidth="220" d:DesignHeight="600"
             x:Class="PrivStack.Desktop.Views.NavigationSidebar"
             x:DataType="vm:MainWindowViewModel">

    <!-- Clean nav button template — replaces FluentTheme's Button ControlTheme for nav items.
         NavBorder owns its own Background (NOT TemplateBinding) with a BrushTransition.
         Local styles target Border#NavBorder directly for hover/active states.
         This fully decouples visual background from Button.Background, so Fluent's
         :pointerover style (which sets Button.Background to white) has zero visual effect. -->
    <UserControl.Resources>
        <ControlTheme x:Key="NavButtonTheme" TargetType="Button">
            <Setter Property="Template">
                <ControlTemplate>
                    <!-- NavBorder owns its own Background — NOT TemplateBinding.
                         This decouples it from Button.Background so Fluent's
                         :pointerover style (which sets Button.Background to white)
                         has zero visual effect. Local styles target NavBorder directly. -->
                    <Border Name="NavBorder" Background="Transparent"
                            CornerRadius="{TemplateBinding CornerRadius}"
                            Padding="{TemplateBinding Padding}">
                        <Border.Transitions>
                            <Transitions>
                                <BrushTransition Property="Background" Duration="0:0:0.15"/>
                            </Transitions>
                        </Border.Transitions>
                        <ContentPresenter Name="NavContent"
                                          Content="{TemplateBinding Content}"
                                          ContentTemplate="{TemplateBinding ContentTemplate}"
                                          Foreground="{TemplateBinding Foreground}"
                                          HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                          VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"/>
                    </Border>
                </ControlTemplate>
            </Setter>
        </ControlTheme>
    </UserControl.Resources>

    <UserControl.Styles>

        <!-- ── Sidebar container ──────────────────────────────────── -->
        <Style Selector="Border.sidebar-container">
            <Setter Property="Background" Value="{DynamicResource ThemeNavGradientBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource ThemeNavBorderBrush}"/>
            <Setter Property="BorderThickness" Value="0,0,1,0"/>
            <Setter Property="BoxShadow" Value="2 0 12 0 #18000000"/>
        </Style>

        <!-- ── Workspace card button ──────────────────────────────── -->
        <Style Selector="Button.workspace-btn">
            <Setter Property="Theme" Value="{StaticResource NavButtonTheme}"/>
            <Setter Property="Foreground" Value="{DynamicResource ThemeNavTextBrush}"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="8,4,8,4"/>
            <Setter Property="CornerRadius" Value="10"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.workspace-btn:pointerover /template/ Border#NavBorder">
            <Setter Property="Background" Value="{DynamicResource ThemeNavHoverBrush}"/>
        </Style>
        <Style Selector="Button.workspace-btn:pressed /template/ Border#NavBorder">
            <Setter Property="Background" Value="{DynamicResource ThemeNavSelectedBrush}"/>
        </Style>

        <!-- ── Nav item wrapper: holds the 3-px left accent bar ───── -->
        <Style Selector="Border.nav-item-wrapper">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="3,0,0,0"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="RenderTransform" Value="none"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="BorderBrush" Duration="0:0:0.18"/>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" Easing="CubicEaseOut"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Border.nav-item-wrapper.active">
            <Setter Property="BorderBrush" Value="{DynamicResource ThemePrimaryBrush}"/>
        </Style>
        <Style Selector="Border.nav-item-wrapper.dragging">
            <Setter Property="Opacity" Value="0.3"/>
        </Style>

        <!-- ── Nav item button ────────────────────────────────────── -->
        <!-- Hover/active styles target Border#NavBorder directly (not Button.Background)
             so Fluent's :pointerover override is invisible. BrushTransition on NavBorder
             gives smooth animated hover. TextBlock.nav-label Foreground set directly. -->
        <Style Selector="Button.nav-item">
            <Setter Property="Theme" Value="{StaticResource NavButtonTheme}"/>
            <Setter Property="Foreground" Value="{DynamicResource ThemeNavTextBrush}"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="6,1,8,1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.nav-item:pointerover /template/ Border#NavBorder">
            <Setter Property="Background" Value="{DynamicResource ThemeNavHoverBrush}"/>
        </Style>
        <!-- Active declared after hover so it wins when both classes apply -->
        <Style Selector="Button.nav-item.active /template/ Border#NavBorder">
            <Setter Property="Background" Value="{DynamicResource ThemePrimaryMutedBrush}"/>
        </Style>
        <Style Selector="Button.nav-item.locked">
            <Setter Property="Opacity" Value="0.45"/>
            <Setter Property="Cursor" Value="Arrow"/>
        </Style>

        <!-- ── Icon bubble inside nav items ──────────────────────── -->
        <Style Selector="Border.nav-icon-bubble">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="Width" Value="28"/>
            <Setter Property="Height" Value="28"/>
            <Setter Property="CornerRadius" Value="7"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Background" Duration="0:0:0.12"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Button.nav-item.active Border.nav-icon-bubble">
            <Setter Property="Background" Value="{DynamicResource ThemePrimaryMutedBrush}"/>
        </Style>

        <!-- ── Icon stroke inside nav item bubble ─────────────────── -->
        <Style Selector="Button.nav-item controls|IconControl">
            <Setter Property="Stroke" Value="{DynamicResource ThemeNavTextBrush}"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Stroke" Duration="0:0:0.12"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Button.nav-item:pointerover controls|IconControl">
            <Setter Property="Stroke" Value="{DynamicResource ThemeNavTextHoverBrush}"/>
        </Style>
        <Style Selector="Button.nav-item.active controls|IconControl">
            <Setter Property="Stroke" Value="{DynamicResource ThemePrimaryBrush}"/>
        </Style>

        <!-- ── Nav item label — direct Foreground to bypass ContentPresenter ──── -->
        <Style Selector="Button.nav-item TextBlock.nav-label">
            <Setter Property="Foreground" Value="{DynamicResource ThemeNavTextBrush}"/>
            <Setter Property="Margin" Value="10,0,0,0"/>
            <Setter Property="FontSize" Value="{DynamicResource ThemeFontSizeSmMd}"/>
            <Setter Property="FontWeight" Value="Normal"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Button.nav-item:pointerover TextBlock.nav-label">
            <Setter Property="Foreground" Value="{DynamicResource ThemeNavTextHoverBrush}"/>
        </Style>
        <Style Selector="Button.nav-item.active TextBlock.nav-label">
            <Setter Property="Foreground" Value="{DynamicResource ThemeNavTextHoverBrush}"/>
            <Setter Property="FontWeight" Value="Medium"/>
        </Style>

        <!-- ── Collapsed nav items (icons only) ───────────────────── -->
        <Style Selector="Button.nav-item-collapsed">
            <Setter Property="Theme" Value="{StaticResource NavButtonTheme}"/>
            <Setter Property="Foreground" Value="{DynamicResource ThemeNavTextBrush}"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="6,1,8,1"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Cursor" Value="Hand"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
        </Style>
        <Style Selector="Button.nav-item-collapsed:pointerover /template/ Border#NavBorder">
            <Setter Property="Background" Value="{DynamicResource ThemeNavHoverBrush}"/>
        </Style>
        <Style Selector="Button.nav-item-collapsed:pressed /template/ Border#NavBorder">
            <Setter Property="Background" Value="{DynamicResource ThemeNavSelectedBrush}"/>
        </Style>
        <Style Selector="Button.nav-item-collapsed.active /template/ Border#NavBorder">
            <Setter Property="Background" Value="{DynamicResource ThemePrimaryMutedBrush}"/>
        </Style>
        <Style Selector="Button.nav-item-collapsed.locked">
            <Setter Property="Opacity" Value="0.45"/>
            <Setter Property="Cursor" Value="Arrow"/>
        </Style>
        <Style Selector="Button.nav-item-collapsed controls|IconControl">
            <Setter Property="Stroke" Value="{DynamicResource ThemeNavTextBrush}"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Stroke" Duration="0:0:0.12"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Button.nav-item-collapsed:pointerover controls|IconControl">
            <Setter Property="Stroke" Value="{DynamicResource ThemeNavTextHoverBrush}"/>
        </Style>
        <Style Selector="Button.nav-item-collapsed.active controls|IconControl">
            <Setter Property="Stroke" Value="{DynamicResource ThemePrimaryBrush}"/>
        </Style>

        <!-- Collapsed wrapper also gets the accent bar -->
        <Style Selector="Border.nav-item-wrapper-collapsed">
            <Setter Property="Background" Value="Transparent"/>
            <Setter Property="BorderThickness" Value="3,0,0,0"/>
            <Setter Property="BorderBrush" Value="Transparent"/>
            <Setter Property="RenderTransform" Value="none"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="BorderBrush" Duration="0:0:0.18"/>
                    <TransformOperationsTransition Property="RenderTransform" Duration="0:0:0.2" Easing="CubicEaseOut"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Border.nav-item-wrapper-collapsed.active">
            <Setter Property="BorderBrush" Value="{DynamicResource ThemePrimaryBrush}"/>
        </Style>
        <Style Selector="Border.nav-item-wrapper-collapsed.dragging">
            <Setter Property="Opacity" Value="0.3"/>
        </Style>

        <!-- ── Footer items ───────────────────────────────────────── -->
        <Style Selector="Button.nav-footer-item">
            <Setter Property="Theme" Value="{StaticResource NavButtonTheme}"/>
            <Setter Property="Foreground" Value="{DynamicResource ThemeNavTextBrush}"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="8,1"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.nav-footer-item:pointerover /template/ Border#NavBorder">
            <Setter Property="Background" Value="{DynamicResource ThemeNavHoverBrush}"/>
        </Style>
        <!-- Footer TextBlock Foreground — direct target bypasses ContentPresenter -->
        <Style Selector="Button.nav-footer-item TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource ThemeNavTextBrush}"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Foreground" Duration="0:0:0.15"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Button.nav-footer-item:pointerover TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource ThemeNavTextHoverBrush}"/>
        </Style>
        <Style Selector="Button.nav-footer-item controls|IconControl">
            <Setter Property="Stroke" Value="{DynamicResource ThemeNavTextBrush}"/>
            <Setter Property="Transitions">
                <Transitions>
                    <BrushTransition Property="Stroke" Duration="0:0:0.12"/>
                </Transitions>
            </Setter>
        </Style>
        <Style Selector="Button.nav-footer-item:pointerover controls|IconControl">
            <Setter Property="Stroke" Value="{DynamicResource ThemeNavTextHoverBrush}"/>
        </Style>

        <Style Selector="Button.nav-footer-item-collapsed">
            <Setter Property="Theme" Value="{StaticResource NavButtonTheme}"/>
            <Setter Property="Foreground" Value="{DynamicResource ThemeNavTextBrush}"/>
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
            <Setter Property="VerticalContentAlignment" Value="Stretch"/>
            <Setter Property="Padding" Value="0"/>
            <Setter Property="Margin" Value="8,1"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Cursor" Value="Hand"/>
        </Style>
        <Style Selector="Button.nav-footer-item-collapsed:pointerover /template/ Border#NavBorder">
            <Setter Property="Background" Value="{DynamicResource ThemeNavHoverBrush}"/>
        </Style>
        <Style Selector="Button.nav-footer-item-collapsed controls|IconControl">
            <Setter Property="Stroke" Value="{DynamicResource ThemeNavTextBrush}"/>
        </Style>
        <Style Selector="Button.nav-footer-item-collapsed:pointerover controls|IconControl">
            <Setter Property="Stroke" Value="{DynamicResource ThemeNavTextHoverBrush}"/>
        </Style>

        <!-- ── Drag ghost ─────────────────────────────────────────── -->
        <Style Selector="Border.drag-ghost">
            <Setter Property="Background" Value="{DynamicResource ThemeNavBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource ThemePrimaryBrush}"/>
            <Setter Property="BorderThickness" Value="2"/>
            <Setter Property="CornerRadius" Value="8"/>
            <Setter Property="Padding" Value="10,9"/>
            <Setter Property="Opacity" Value="0.9"/>
            <Setter Property="BoxShadow" Value="0 6 20 0 #50000000"/>
        </Style>

    </UserControl.Styles>

    <!-- ═══════════════════════════════════════════════════════════ -->
    <!-- Main sidebar layout                                        -->
    <!-- ═══════════════════════════════════════════════════════════ -->
    <Border Classes="sidebar-container">
        <Grid RowDefinitions="Auto,*,Auto">

            <!-- ── Header ──────────────────────────────────────── -->
            <Panel Grid.Row="0">

                <!-- Expanded header -->
                <StackPanel IsVisible="{Binding !IsSidebarCollapsed}">

                    <!-- Brand row: logo + app name -->
                    <StackPanel Orientation="Horizontal" Spacing="10" Margin="16,14,16,6">
                        <controls:LogoControl Width="20" Height="20" VerticalAlignment="Center"/>
                        <TextBlock Text="PrivStack"
                                   FontSize="15" FontWeight="Bold"
                                   Foreground="{DynamicResource ThemeNavTextHoverBrush}"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                    <!-- Workspace card button -->
                    <Button Classes="workspace-btn"
                            Command="{Binding OpenWorkspaceSwitcherCommand}"
                            ToolTip.Tip="Switch Workspace (Ctrl+K W)">
                        <Border Classes="nav-bg" Padding="10,8" CornerRadius="10">
                        <Grid ColumnDefinitions="Auto,*,Auto">
                            <!-- Icon bubble -->
                            <Border Grid.Column="0"
                                    Width="28" Height="28" CornerRadius="8"
                                    Background="{DynamicResource ThemePrimaryMutedBrush}"
                                    VerticalAlignment="Center">
                                <controls:IconControl Icon="Layers" Size="13"
                                                      StrokeThickness="1.5"
                                                      Stroke="{DynamicResource ThemePrimaryBrush}"
                                                      HorizontalAlignment="Center"
                                                      VerticalAlignment="Center"/>
                            </Border>
                            <!-- Name + subtitle -->
                            <StackPanel Grid.Column="1" Margin="10,0" VerticalAlignment="Center" Spacing="1">
                                <TextBlock Text="{Binding CurrentWorkspaceName}"
                                           FontSize="{DynamicResource ThemeFontSizeSm}"
                                           FontWeight="SemiBold"
                                           Foreground="{DynamicResource ThemeNavTextHoverBrush}"
                                           MaxLines="1" TextTrimming="CharacterEllipsis"/>
                                <TextBlock Text="Workspace"
                                           FontSize="{DynamicResource ThemeFontSize2Xs}"
                                           Foreground="{DynamicResource ThemeNavTextBrush}"/>
                            </StackPanel>
                            <!-- Chevron -->
                            <controls:IconControl Grid.Column="2"
                                                  Icon="ChevronsUpDown" Size="12" StrokeThickness="1.5"
                                                  Stroke="{DynamicResource ThemeNavTextBrush}"
                                                  VerticalAlignment="Center"/>
                        </Grid>
                        </Border>
                    </Button>

                    <!-- Divider -->
                    <Border Height="1"
                            Background="{DynamicResource ThemeNavBorderSubtleBrush}"
                            Margin="12,6,12,0"/>
                </StackPanel>

                <!-- Collapsed header: just the logo centred -->
                <Border IsVisible="{Binding IsSidebarCollapsed}"
                        Padding="0,12,0,8"
                        HorizontalAlignment="Stretch">
                    <controls:LogoControl Width="20" Height="20"
                                          HorizontalAlignment="Center"
                                          VerticalAlignment="Center"/>
                </Border>
            </Panel>

            <!-- ── Navigation items ────────────────────────────── -->
            <ScrollViewer Grid.Row="1"
                          HorizontalScrollBarVisibility="Disabled"
                          VerticalScrollBarVisibility="Auto"
                          Padding="0,6,0,6">
                <Grid>

                    <!-- Expanded mode -->
                    <ItemsControl x:Name="ExpandedNavItems"
                                  ItemsSource="{Binding NavigationItems}"
                                  IsVisible="{Binding !IsSidebarCollapsed}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="sdk:NavigationItem">
                                <Border Classes="nav-item-wrapper"
                                        Classes.active="{Binding IsSelected}"
                                        Background="Transparent">
                                    <Button Classes="nav-item"
                                            Classes.active="{Binding IsSelected}"
                                            Classes.locked="{Binding IsHardLocked}"
                                            Command="{Binding $parent[UserControl].((vm:MainWindowViewModel)DataContext).SelectTabCommand}"
                                            CommandParameter="{Binding Id}"
                                            IsEnabled="{Binding IsEnabled}"
                                            ToolTip.Tip="{Binding Tooltip}">
                                        <Border Classes="nav-bg" Padding="8,9" CornerRadius="8">
                                            <Grid ColumnDefinitions="Auto,*,Auto">
                                                <!-- Icon bubble -->
                                                <Border Classes="nav-icon-bubble" VerticalAlignment="Center">
                                                    <controls:IconControl Icon="{Binding Icon}"
                                                                          Size="15" StrokeThickness="1.5"
                                                                          HorizontalAlignment="Center"
                                                                          VerticalAlignment="Center"/>
                                                </Border>
                                                <!-- Label -->
                                                <TextBlock Grid.Column="1"
                                                           Text="{Binding DisplayName}"
                                                           Classes="nav-label"/>
                                                <!-- Release stage badges -->
                                                <StackPanel Grid.Column="2" Orientation="Horizontal" VerticalAlignment="Center" Margin="4,0,0,0">
                                                    <Border CornerRadius="4" Padding="4,1" IsVisible="{Binding IsAlpha}" Background="{DynamicResource ThemeAlphaBadgeBrush}">
                                                        <TextBlock Text="A" FontSize="9" Foreground="{DynamicResource ThemeTextOnAccentBrush}" FontWeight="Bold"/>
                                                    </Border>
                                                    <Border CornerRadius="4" Padding="4,1" IsVisible="{Binding IsBeta}" Background="{DynamicResource ThemeBetaBadgeBrush}">
                                                        <TextBlock Text="B" FontSize="9" Foreground="{DynamicResource ThemeTextOnAccentBrush}" FontWeight="Bold"/>
                                                    </Border>
                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </Button>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Collapsed mode (icon only) -->
                    <ItemsControl x:Name="CollapsedNavItems"
                                  ItemsSource="{Binding NavigationItems}"
                                  IsVisible="{Binding IsSidebarCollapsed}"
                                  HorizontalAlignment="Stretch">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate x:DataType="sdk:NavigationItem">
                                <!-- Use nav-item-wrapper so drag code-behind finds the right element -->
                                <Border Classes="nav-item-wrapper"
                                        Classes.active="{Binding IsSelected}"
                                        Background="Transparent">
                                    <Button Classes="nav-item-collapsed"
                                            Classes.active="{Binding IsSelected}"
                                            Classes.locked="{Binding IsHardLocked}"
                                            Command="{Binding $parent[UserControl].((vm:MainWindowViewModel)DataContext).SelectTabCommand}"
                                            CommandParameter="{Binding Id}"
                                            IsEnabled="{Binding IsEnabled}"
                                            ToolTip.Tip="{Binding DisplayName}">
                                        <Border Classes="nav-bg" Padding="8" CornerRadius="8"
                                                HorizontalAlignment="Stretch">
                                            <!-- Icon bubble centred in collapsed mode -->
                                            <Border Width="28" Height="28" CornerRadius="7"
                                                    HorizontalAlignment="Center"
                                                    VerticalAlignment="Center">
                                                <controls:IconControl Icon="{Binding Icon}"
                                                                      Size="15" StrokeThickness="1.5"
                                                                      HorizontalAlignment="Center"
                                                                      VerticalAlignment="Center"/>
                                            </Border>
                                        </Border>
                                    </Button>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <!-- Drag overlay canvas (floating ghost) -->
                    <Canvas x:Name="DragOverlay"
                            IsHitTestVisible="False"
                            ZIndex="1000"/>
                </Grid>
            </ScrollViewer>

            <!-- ── Footer ──────────────────────────────────────── -->
            <Border Grid.Row="2" Padding="0,8,0,4"
                    BorderBrush="{DynamicResource ThemeNavBorderSubtleBrush}"
                    BorderThickness="0,1,0,0">
                <StackPanel>

                    <!-- Expanded footer -->
                    <StackPanel IsVisible="{Binding !IsSidebarCollapsed}" Spacing="2">

                        <!-- Active timers -->
                        <ItemsControl ItemsSource="{Binding AllActiveTimers}"
                                      IsVisible="{Binding HasActiveTimers}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="cap:ActiveTimerInfo">
                                    <Button Classes="nav-footer-item"
                                            Command="{Binding $parent[UserControl].((vm:MainWindowViewModel)DataContext).NavigateToSpecificTimerCommand}"
                                            CommandParameter="{Binding ItemId}"
                                            ToolTip.Tip="{Binding Title}">
                                        <Border Classes="nav-bg" Padding="10,7" CornerRadius="6">
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <!-- Running/paused dot -->
                                            <Panel Grid.Column="0" Width="8" Height="8" VerticalAlignment="Center">
                                                <Border Width="8" Height="8" CornerRadius="4"
                                                        Background="{DynamicResource ThemeSuccessBrush}"
                                                        IsVisible="{Binding IsRunning}"/>
                                                <Border Width="8" Height="8" CornerRadius="4"
                                                        Background="{DynamicResource ThemeWarningBrush}"
                                                        IsVisible="{Binding !IsRunning}"/>
                                            </Panel>
                                            <!-- Title + elapsed -->
                                            <StackPanel Grid.Column="1" Margin="10,0,0,0" VerticalAlignment="Center">
                                                <TextBlock Text="{Binding Title}"
                                                           FontSize="{DynamicResource ThemeFontSizeXsSm}"
                                                           MaxLines="1" TextTrimming="CharacterEllipsis"/>
                                                <TextBlock Text="{Binding ElapsedDisplay}"
                                                           FontSize="{DynamicResource ThemeFontSizeSm}" FontWeight="SemiBold"
                                                           Foreground="{DynamicResource ThemeSuccessBrush}"/>
                                            </StackPanel>
                                            <!-- Stop -->
                                            <Button Grid.Column="2"
                                                    Command="{Binding $parent[UserControl].((vm:MainWindowViewModel)DataContext).StopSpecificTimerCommand}"
                                                    CommandParameter="{Binding ItemId}"
                                                    Background="Transparent" Padding="4" Margin="4,0,0,0"
                                                    CornerRadius="4" Cursor="Hand"
                                                    VerticalAlignment="Center"
                                                    ToolTip.Tip="Stop Timer">
                                                <controls:IconControl Icon="Square" Size="12" StrokeThickness="1.5"
                                                                      Stroke="{DynamicResource ThemeDangerBrush}"/>
                                            </Button>
                                        </Grid>
                                        </Border>
                                    </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- Collapse toggle -->
                        <Button Classes="nav-footer-item"
                                Command="{Binding ToggleSidebarCommand}"
                                ToolTip.Tip="{Binding SidebarCollapseTooltip}">
                            <Border Classes="nav-bg" Padding="10,7" CornerRadius="6">
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <controls:IconControl Icon="PanelLeftClose" Size="16" StrokeThickness="1.5"/>
                                <TextBlock Text="Collapse" FontSize="{DynamicResource ThemeFontSizeSm}"/>
                            </StackPanel>
                            </Border>
                        </Button>

                        <!-- Search / command palette -->
                        <Button Classes="nav-footer-item"
                                Command="{Binding CommandPaletteVM.ToggleCommand}"
                                ToolTip.Tip="Command Palette (Cmd+K)">
                            <Border Classes="nav-bg" Padding="10,7" CornerRadius="6">
                            <StackPanel Orientation="Horizontal" Spacing="10">
                                <controls:IconControl Icon="Search" Size="16" StrokeThickness="1.5"/>
                                <TextBlock Text="Search" FontSize="{DynamicResource ThemeFontSizeSm}"/>
                            </StackPanel>
                            </Border>
                        </Button>

                        <!-- Sync status -->
                        <Button Classes="nav-footer-item"
                                Command="{Binding OpenSyncFromMenuCommand}"
                                ToolTip.Tip="Sync Settings">
                            <Border Classes="nav-bg" Padding="10,7" CornerRadius="6">
                            <Grid ColumnDefinitions="Auto,*,Auto">
                                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="10">
                                    <controls:IconControl Icon="Sync" Size="16" StrokeThickness="1.5"/>
                                    <TextBlock Text="Sync" FontSize="{DynamicResource ThemeFontSizeSm}"/>
                                </StackPanel>
                                <Border Grid.Column="2" Width="7" Height="7" CornerRadius="4"
                                        VerticalAlignment="Center" Margin="8,0,0,0"
                                        Background="{DynamicResource ThemeSuccessBrush}"/>
                            </Grid>
                            </Border>
                        </Button>

                        <!-- User + Settings row -->
                        <Grid ColumnDefinitions="*,Auto" Margin="8,2">
                            <!-- User profile -->
                            <Button Grid.Column="0" Classes="nav-footer-item"
                                    Margin="0"
                                    Command="{Binding ToggleUserMenuCommand}">
                                <Border Classes="nav-bg" Padding="10,7" CornerRadius="6">
                                <StackPanel Orientation="Horizontal" Spacing="10">
                                    <Border Width="26" Height="26" CornerRadius="13"
                                            ClipToBounds="True"
                                            Background="{DynamicResource ThemePrimaryBrush}">
                                        <Panel>
                                            <Image Source="{Binding UserProfileImage}"
                                                   IsVisible="{Binding HasProfileImage}"
                                                   Width="26" Height="26"
                                                   Stretch="UniformToFill"/>
                                            <TextBlock Text="{Binding UserInitial}"
                                                       IsVisible="{Binding !HasProfileImage}"
                                                       FontSize="{DynamicResource ThemeFontSizeXsSm}" FontWeight="SemiBold"
                                                       Foreground="{DynamicResource ThemeTextOnAccentBrush}"
                                                       HorizontalAlignment="Center"
                                                       VerticalAlignment="Center"/>
                                        </Panel>
                                    </Border>
                                    <TextBlock Text="{Binding UserDisplayName}"
                                               FontSize="{DynamicResource ThemeFontSizeSm}" FontWeight="Medium"
                                               Foreground="{DynamicResource ThemeNavTextHoverBrush}"
                                               VerticalAlignment="Center"
                                               MaxLines="1" TextTrimming="CharacterEllipsis"/>
                                </StackPanel>
                                </Border>
                            </Button>
                            <!-- Settings gear -->
                            <Button Grid.Column="1"
                                    Command="{Binding OpenSettingsCommand}"
                                    ToolTip.Tip="Settings"
                                    Background="Transparent"
                                    Padding="8"
                                    Margin="4,0,0,0"
                                    CornerRadius="6"
                                    VerticalAlignment="Center"
                                    Cursor="Hand">
                                <controls:IconControl Icon="Settings" Size="16" StrokeThickness="1.5"
                                                      Stroke="{DynamicResource ThemeNavTextBrush}"/>
                            </Button>
                        </Grid>

                    </StackPanel>

                    <!-- Collapsed footer (icons only) -->
                    <StackPanel IsVisible="{Binding IsSidebarCollapsed}"
                                HorizontalAlignment="Stretch" Spacing="2">

                        <!-- Active timer indicator -->
                        <Border x:Name="CollapsedTimerIndicator"
                                IsVisible="{Binding HasActiveTimers}"
                                Background="Transparent"
                                Padding="10,7" Margin="8,1" CornerRadius="6"
                                Cursor="Hand"
                                PointerEntered="OnCollapsedTimerPointerEnter"
                                PointerExited="OnCollapsedTimerPointerLeave">
                            <Panel HorizontalAlignment="Center">
                                <Border Width="10" Height="10" CornerRadius="5"
                                        Background="{DynamicResource ThemeSuccessBrush}"/>
                            </Panel>
                        </Border>
                        <Popup x:Name="CollapsedTimerPopup"
                               PlacementTarget="{Binding #CollapsedTimerIndicator}"
                               Placement="Right"
                               HorizontalOffset="4"
                               IsLightDismissEnabled="False"
                               IsOpen="False">
                            <Border Background="{DynamicResource ThemeSurfaceBrush}"
                                    BorderBrush="{DynamicResource ThemeBorderBrush}"
                                    BorderThickness="1" CornerRadius="10"
                                    Padding="16,12" MinWidth="240"
                                    BoxShadow="4 4 20 0 #40000000"
                                    PointerEntered="OnTimerPopupPointerEnter"
                                    PointerExited="OnTimerPopupPointerLeave">
                                <StackPanel Spacing="8">
                                    <TextBlock Text="Active Timers"
                                               FontSize="{DynamicResource ThemeFontSizeXsSm}"
                                               Foreground="{DynamicResource ThemeTextMutedBrush}"
                                               FontWeight="SemiBold"/>
                                    <ItemsControl ItemsSource="{Binding AllActiveTimers}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate x:DataType="cap:ActiveTimerInfo">
                                                <Border Margin="0,2" Padding="8,6" CornerRadius="6"
                                                        Background="{DynamicResource ThemeSurfaceElevatedBrush}">
                                                    <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto">
                                                        <Panel Grid.Column="0" Grid.RowSpan="2" Width="8" Height="8"
                                                               VerticalAlignment="Center" Margin="0,0,8,0">
                                                            <Border Width="8" Height="8" CornerRadius="4"
                                                                    Background="{DynamicResource ThemeSuccessBrush}"
                                                                    IsVisible="{Binding IsRunning}"/>
                                                            <Border Width="8" Height="8" CornerRadius="4"
                                                                    Background="{DynamicResource ThemeWarningBrush}"
                                                                    IsVisible="{Binding !IsRunning}"/>
                                                        </Panel>
                                                        <TextBlock Grid.Column="1" Grid.Row="0"
                                                                   Text="{Binding Title}"
                                                                   FontSize="{DynamicResource ThemeFontSizeXsSm}"
                                                                   Foreground="{DynamicResource ThemeTextPrimaryBrush}"
                                                                   MaxLines="1" TextTrimming="CharacterEllipsis"/>
                                                        <TextBlock Grid.Column="1" Grid.Row="1"
                                                                   Text="{Binding ElapsedDisplay}"
                                                                   FontSize="{DynamicResource ThemeFontSizeSm}" FontWeight="SemiBold"
                                                                   Foreground="{DynamicResource ThemeSuccessBrush}"/>
                                                        <Button Grid.Column="2" Grid.RowSpan="2"
                                                                Command="{Binding $parent[UserControl].((vm:MainWindowViewModel)DataContext).StopSpecificTimerCommand}"
                                                                CommandParameter="{Binding ItemId}"
                                                                Background="Transparent" Padding="4"
                                                                CornerRadius="4" Cursor="Hand"
                                                                VerticalAlignment="Center"
                                                                ToolTip.Tip="Stop">
                                                            <controls:IconControl Icon="Square" Size="10" StrokeThickness="1.5"
                                                                                  Stroke="{DynamicResource ThemeDangerBrush}"/>
                                                        </Button>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                </StackPanel>
                            </Border>
                        </Popup>

                        <!-- Expand -->
                        <Button Classes="nav-footer-item-collapsed"
                                Command="{Binding ToggleSidebarCommand}"
                                ToolTip.Tip="Expand sidebar">
                            <Border Classes="nav-bg" Padding="10,7" CornerRadius="6" HorizontalAlignment="Stretch">
                                <controls:IconControl Icon="PanelLeftOpen" Size="16" StrokeThickness="1.5" HorizontalAlignment="Center"/>
                            </Border>
                        </Button>

                        <!-- Search -->
                        <Button Classes="nav-footer-item-collapsed"
                                Command="{Binding CommandPaletteVM.ToggleCommand}"
                                ToolTip.Tip="Search (Cmd+K)">
                            <Border Classes="nav-bg" Padding="10,7" CornerRadius="6" HorizontalAlignment="Stretch">
                                <controls:IconControl Icon="Search" Size="16" StrokeThickness="1.5" HorizontalAlignment="Center"/>
                            </Border>
                        </Button>

                        <!-- Sync -->
                        <Button Classes="nav-footer-item-collapsed"
                                Command="{Binding OpenSyncFromMenuCommand}"
                                ToolTip.Tip="Sync">
                            <Border Classes="nav-bg" Padding="10,7" CornerRadius="6" HorizontalAlignment="Stretch">
                                <controls:IconControl Icon="Sync" Size="16" StrokeThickness="1.5" HorizontalAlignment="Center"/>
                            </Border>
                        </Button>

                        <!-- User + Settings row (collapsed) -->
                        <Grid ColumnDefinitions="*,Auto" Margin="8,2">
                            <Button Grid.Column="0" Classes="nav-footer-item-collapsed"
                                    Margin="0"
                                    Command="{Binding ToggleUserMenuCommand}"
                                    ToolTip.Tip="{Binding UserDisplayName}">
                                <Border Width="26" Height="26" CornerRadius="13"
                                        ClipToBounds="True"
                                        Background="{DynamicResource ThemePrimaryBrush}">
                                    <Panel>
                                        <Image Source="{Binding UserProfileImage}"
                                               IsVisible="{Binding HasProfileImage}"
                                               Width="26" Height="26"
                                               Stretch="UniformToFill"/>
                                        <TextBlock Text="{Binding UserInitial}"
                                                   IsVisible="{Binding !HasProfileImage}"
                                                   FontSize="{DynamicResource ThemeFontSizeXsSm}" FontWeight="SemiBold"
                                                   Foreground="{DynamicResource ThemeTextOnAccentBrush}"
                                                   HorizontalAlignment="Center"
                                                   VerticalAlignment="Center"/>
                                    </Panel>
                                </Border>
                            </Button>
                            <Button Grid.Column="1"
                                    Command="{Binding OpenSettingsCommand}"
                                    ToolTip.Tip="Settings"
                                    Background="Transparent"
                                    Padding="8"
                                    Margin="4,0,0,0"
                                    CornerRadius="6"
                                    VerticalAlignment="Center"
                                    Cursor="Hand">
                                <controls:IconControl Icon="Settings" Size="16" StrokeThickness="1.5"
                                                      Stroke="{DynamicResource ThemeNavTextBrush}"/>
                            </Button>
                        </Grid>
                    </StackPanel>

                </StackPanel>
            </Border>

        </Grid>
    </Border>
</UserControl>
